<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>TRASH TALK — Bristol Map (iPhone Ready)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root {
      --text:#374151;
      --muted:#6b7280;
      --bg:#faf9f7;
      --panel:#fffdfb;
      --border:#eeeeee;
      --legend-gap:8px;
      --radius:14px;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); }
    body { font-family: "Poppins", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; color:var(--text); }
    #app { display: grid; grid-template-columns: 340px 1fr; height: 100%; }
    aside { padding: 16px 14px; border-right:1px solid var(--border); background:var(--panel); overflow:auto; }
    h1 { font-weight:600; letter-spacing:.1px; font-size:20px; margin:0 0 8px 0; color:var(--text); }
    .sub { color:var(--muted); font-size:12px; margin-bottom:12px; line-height:1.4; }
    .legend { display:grid; gap:var(--legend-gap); margin: 8px 0 12px 0; }
    .legend-item { display:flex; align-items:center; gap:8px; font-size:13px; }
    .dot { width:12px; height:12px; border-radius:6px; display:inline-block; border:1px solid rgba(0,0,0,.08); }
    .dot.blue { background:#bfe3ff; }
    .dot.pink { background:#ffd6e7; }
    .dot.yellow { background:#fff1b6; }
    #map { width:100%; height:100%; }

    .section { margin: 12px 0; }
    .section-title { font-weight:600; font-size:13px; color:var(--text); margin-bottom:6px; }
    .item { font-weight:400; font-size:13px; margin: 3px 0; line-height:1.5; }
    .item a { color:#4b5563; text-decoration: underline; text-underline-offset:2px; }

    .note { font-size: 11px; color:#9CA3AF; margin-top: 8px; }
    .source-note { position:absolute; right:12px; bottom:10px; background: rgba(255,255,255,.9); padding:6px 8px; border-radius:var(--radius); font-size:11px; color:#6b7280; border:1px solid var(--border); }

    /* Poppins everywhere inside Leaflet UI + touch-friendly sizes */
    .leaflet-container, .leaflet-container .leaflet-control, .leaflet-control, .leaflet-tooltip, .leaflet-popup-content, .leaflet-popup-tip, .leaflet-control-layers, .leaflet-control-attribution {
      font-family: "Poppins", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial !important;
    }
    .leaflet-tooltip { font-weight:500; }
    .leaflet-popup-content { font-size:14px; line-height:1.5; }
    .leaflet-popup-content strong { font-weight:600; }
    .leaflet-control-layers { font-size:14px; }
    .leaflet-control-zoom a { width:36px; height:36px; line-height:36px; font-size:18px; }
    .leaflet-touch .leaflet-bar a { width:36px; height:36px; line-height:36px; }

    /* Mobile layout */
    @media (max-width: 820px) {
      #app { grid-template-columns: 1fr; }
      aside {
        position: absolute;
        z-index: 1000;
        top: env(safe-area-inset-top);
        left: env(safe-area-inset-left);
        right: env(safe-area-inset-right);
        width: min(92vw, 440px);
        max-height: 80vh;
        box-shadow: 0 10px 30px rgba(0,0,0,.08);
        border:1px solid var(--border);
        border-radius: 14px;
        margin: 10px auto 0;
        inset-inline: 4%;
        transform: translateY(-120%);
        transition: transform .28s ease;
      }
      aside.open { transform: translateY(0); }
      .toggle {
        position: absolute;
        z-index: 1100;
        top: calc(env(safe-area-inset-top) + 10px);
        left: calc(env(safe-area-inset-left) + 10px);
        background:#ffffff;
        border:1px solid var(--border);
        border-radius: 999px;
        padding: 10px 12px;
        font-size: 14px;
        color:#374151;
        box-shadow: 0 6px 20px rgba(0,0,0,.08);
      }
      .toggle:active { transform: translateY(1px); }
      .legend { margin-top: 6px; }
      .leaflet-control-layers { font-size:13px; }
    }
  </style>
</head>
<body>
  <button class="toggle" aria-controls="sidebar" aria-expanded="false">☰ Menu</button>
  <div id="app">
    <aside id="sidebar">
      <h1 id="title">TRASH TALK — Bristol Map</h1>
      <div id="subtitle" class="sub">Clean &amp; modern pastel. <strong>Tap</strong> a marker to see its details.</div>

      <div class="legend">
        <div class="legend-item"><span class="dot blue"></span> Car boot / markets</div>
        <div class="legend-item"><span class="dot pink"></span> Recycling centres</div>
        <div class="legend-item"><span class="dot yellow"></span> Charities (furniture & collections)</div>
      </div>

      <!-- Sidebar content (no tags section) -->
      <div id="custom-sections"></div>
      <div class="note">Clothing Banks pinned at Reuse Shop, 83 Hartcliffe Way (fixed). Bulky Waste removed.</div>
    </aside>
    <div id="map"></div>
  </div>

  <!-- === SIDEBAR CONTENT JSON === -->
  <script id="sidebar-data" type="application/json">
  {
    "title": "TRASH TALK",
    "subtitle": "Don't waste what works! Find alternatives to fly tipping with better ways to reuse, repair and share, so you can be part of Bristols cleaner, greener future! ·",
    "sections": [
      {
        "title": "Recycle centres",
        "items": [
          "• St Philips Reuse & Recycling Centre",
          "• Hartcliffe Way Reuse & Recycling Centre",
          "• Avonmouth Reuse & Recycling Centre",
          "• Mangotsfield Sort It Recycling Centre",
          "• Thornbury Sort It Recycling Centre",
          "• Clothing banks (Bristol Waste) — Reuse Shop, 83 Hartcliffe Way"
        ]
      },
      {
        "title": "Car boot sales",
        "items": [
          "• Clifton Car Boot Sale (The Clanage)",
          "• Whitchurch Car Boot — Sundays",
          "• Bath Racecourse Car Boot — Apr–Oct Saturdays",
          "• Nailsea Car Boot — every other Saturday",
          "• Easter Compton Car Boot",
          "• Trench Lane Car Boot",
          "• Keynsham RFC Boot Sale"
        ]
      },
      {
        "title": "Charities & Collections",
        "items": [
          "• SOFA Project 07866 730963",
          "• Emmaus Bristol 0117 954 0886",
          "• Happytat 0117 329 1747",
          "• St Peter’s Hospice  0117 915 9400",
          "• British Heart Foundation 0117 321 5023",
          "• Over2Hills — office furniture recycling",
          "• Recycle & Donate — free furniture collections",
          "• Zero Waste Group — sofa/furniture recycling"
        ]
      }
    ]
  }
  </script>

  <!-- === EXTRA CAR BOOT SALES (dynamic geocode) === -->
  <script id="extra-markets" type="application/json">
  [
    { "name": "Whitchurch Car Boot Sale", "query": "Whitchurch Sports Centre, Bamfield, Bristol BS14 0XA", "details": "Every Sunday morning." },
    { "name": "Bath Racecourse Car Boot", "query": "Bath Racecourse, Lansdown, Bath", "details": "Saturdays April–October." },
    { "name": "Nailsea Car Boot", "query": "West End Park, Nailsea", "details": "Every other Saturday." },
    { "name": "Easter Compton Car Boot Sale", "query": "Easter Compton Car Boot Sale, Almondsbury, Bristol", "details": "Popular weekend boot sale north of Bristol." },
    { "name": "Trench Lane Car Boot", "query": "Trench Lane, Bradley Stoke / Almondsbury, Bristol", "details": "Large boot sale site near Almondsbury." },
    { "name": "Keynsham Rugby Club Boot Sale", "query": "Keynsham Rugby Football Club, Bristol Road, Keynsham", "details": "Seasonal boot sale just SE of Bristol." }
  ]
  </script>

  <!-- === EXTRA RECYCLING (dynamic geocode) === -->
  <script id="extra-recycling" type="application/json">
  [
    { "name": "Mangotsfield Sort It Recycling Centre", "query": "Mangotsfield Sort It Centre, Carsons Road, BS16 9LL", "details": "South Gloucestershire site just outside Bristol." },
    { "name": "Thornbury Sort It Recycling Centre", "query": "Thornbury Sort It Recycling Centre, Short Way, BS35 3UT", "details": "Regional recycling centre north of Bristol." }
  ]
  </script>

  <!-- === EXTRA COLLECTION SERVICES (dynamic geocode → charities layer) === -->
  <script id="extra-collections" type="application/json">
  [
    { "name": "Over2Hills (Office furniture recycling)", "query": "Over2Hills Bristol", "details": "Office furniture recycling in Bristol & South West. Donate/refurbish." },
    { "name": "Recycle & Donate (Bristol)", "query": "Access House, Marsh Road, Ashton Gate, Bristol BS3 2LG", "details": "Free collection of unwanted furniture across Bristol." },
    { "name": "Zero Waste Group (Bristol)", "query": "Zero Waste Group Bristol", "details": "Furniture/sofa removal & recycling service in Bristol." }
  ]
  </script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // Sidebar init
    (function loadSidebar(){
      try {
        const raw = document.getElementById('sidebar-data').textContent;
        const cfg = JSON.parse(raw);
        if (cfg.title) document.getElementById('title').textContent = cfg.title;
        if (cfg.subtitle) document.getElementById('subtitle').textContent = cfg.subtitle;
        const holder = document.getElementById('custom-sections');
        holder.innerHTML = "";
        (cfg.sections || []).forEach(sec => {
          const s = document.createElement('div');
          s.className = 'section';
          const h = document.createElement('div');
          h.className = 'section-title';
          h.textContent = sec.title || "";
          s.appendChild(h);
          (sec.items || []).forEach(txt => {
            const p = document.createElement('div');
            p.className = 'item';
            const html = (txt || "").replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
            p.innerHTML = html;
            s.appendChild(p);
          });
          holder.appendChild(s);
        });
      } catch(e) {
        console.error('Sidebar JSON error', e);
      }
    })();

    // iOS-friendly full-height map
    function setMapHeight() {
      const mapEl = document.getElementById('map');
      mapEl.style.height = window.innerHeight + 'px';
    }
    setMapHeight();
    window.addEventListener('resize', setMapHeight);
    window.addEventListener('orientationchange', setMapHeight);

    // Mobile sidebar toggle
    const toggleBtn = document.querySelector('.toggle');
    const sidebar = document.getElementById('sidebar');
    function toggleSidebar() {
      const isOpen = sidebar.classList.toggle('open');
      toggleBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      // Adjust map size after sidebar animation
      setTimeout(() => { setMapHeight(); }, 320);
    }
    toggleBtn.addEventListener('click', toggleSidebar);

    // Leaflet map
    function pastelMarker(color) {
      const svg = encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='28' height='40' viewBox='0 0 28 40'>
          <defs><filter id='s' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur stdDeviation='1.2' /></filter></defs>
          <ellipse cx='14' cy='38' rx='6' ry='2' fill='rgba(0,0,0,.18)' filter='url(#s)'/>
          <path d='M14 0c6.9 0 12.5 5.6 12.5 12.5 0 7.7-8.9 17.6-12.1 23.4a1 1 0 0 1-1.8 0C8.4 30 1.5 20.2 1.5 12.5 1.5 5.6 7.1 0 14 0z' fill='${color}' stroke='rgba(0,0,0,.08)'/>
          <circle cx='14' cy='12' r='4.2' fill='rgba(255,255,255,.9)'/>
        </svg>
      `);
      return L.icon({ iconUrl: 'data:image/svg+xml;charset=UTF-8,' + svg, iconSize: [28,40], iconAnchor:[14,38], popupAnchor:[0,-34], tooltipAnchor:[0,-22] });
    }

    const map = L.map('map').setView([51.4545, -2.5879], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO', maxZoom: 19
    }).addTo(map);

    // Three layers: markets, recycling, charities
    const layers = {
      markets: L.layerGroup().addTo(map),
      recycling: L.layerGroup().addTo(map),
      charities: L.layerGroup().addTo(map)
    };

    // Fixed coordinates
    const places = [
      // Market
      { name: "Clifton Car Boot Sale", addr: "The Clanage, Clanage Rd, Bristol BS3 2JX", lat: 51.443621, lon: -2.628039, group: "markets", color: "#bfe3ff", details: "Weekly car boot at The Clanage sports fields." },

      // Recycling centres (Bristol)
      { name: "Hartcliffe Way Reuse & Recycling Centre", addr: "83 Hartcliffe Way, Bristol BS3 5RN", lat: 51.427857, lon: -2.602782, group: "recycling", color: "#ffd6e7", details: "Household Reuse & Recycling Centre." },
      { name: "St Philips Reuse & Recycling Centre", addr: "Folly Lane, off Days Road, Bristol BS2 0QS", lat: 51.455278, lon: -2.571667, group: "recycling", color: "#ffd6e7", details: "Household Reuse & Recycling Centre." },
      { name: "Avonmouth Reuse & Recycling Centre", addr: "Kings Weston Lane, Avonmouth, Bristol BS11 0YS", lat: 51.515103, lon: -2.673756, group: "recycling", color: "#ffd6e7", details: "Household Reuse & Recycling Centre." },

      // Fixed marker for Clothing Banks (representative at Reuse Shop)
      { name: "Clothing banks (Bristol Waste – representative)", addr: "Reuse Shop, 83 Hartcliffe Way, Bristol BS3 5RN", lat: 51.427857, lon: -2.602782, group: "recycling", color: "#ffd6e7", details: "City‑wide clothing & textile drop‑off points. Pinned at the Reuse Shop." },

      // Charities
      { name: "SOFA Project (Old Market)", addr: "48–54 West Street, St Philips, Bristol BS2 0BL", lat: 51.457046, lon: -2.57733, group: "charities", color: "#fff1b6", details: "Donations of reusable furniture & homeware." },
      { name: "Emmaus Bristol (Backfields House)", addr: "Upper York Street, Bristol BS2 8QJ", lat: 51.461628, lon: -2.589032, group: "charities", color: "#fff1b6", details: "Collects furniture and offers house clearances." },
      { name: "Happytat (Stokes Croft)", addr: "Stokes Croft, Bristol BS1 3TB", lat: 51.46068, lon: -2.59139, group: "charities", color: "#fff1b6", details: "Accepts furniture; free collection after photo approval." },
      { name: "St Peter’s Hospice (Clifton Superstore)", addr: "Berkeley Place / Jacob’s Wells Rd, Bristol BS8 1EH", lat: 51.455733, lon: -2.609366, group: "charities", color: "#fff1b6", details: "Superstore with free furniture collection service." },
      { name: "British Heart Foundation (Horsefair F&E)", addr: "50–58 Horsefair, Bristol BS1 3JQ", lat: 51.458625, lon: -2.588994, group: "charities", color: "#fff1b6", details: "Furniture & Electrical store; free home collections." }
    ];

    const bounds = [];
    for (const p of places) {
      const marker = L.marker([p.lat, p.lon], { icon: pastelMarker(p.color), title: p.name });
      marker.bindPopup(`<strong>${p.name}</strong><br/><div style="color:#6b7280">${p.addr}</div><hr style="border:none;border-top:1px solid #eee;margin:8px 0"/><div style="font-size:13px">${p.details}</div>`);
      layers[p.group].addLayer(marker);
      bounds.push([p.lat, p.lon]);
    }

    // Dynamic adders (markets, extra recycling, extra collections)
    async function addDynamic(typeId, layerKey, color) {
      try {
        const raw = document.getElementById(typeId).textContent;
        const items = JSON.parse(raw);
        const NOMINATIM = "https://nominatim.openstreetmap.org/search";
        for (const m of items) {
          const url = new URL(NOMINATIM);
          url.searchParams.set('q', m.query);
          url.searchParams.set('format', 'json');
          url.searchParams.set('limit', '1');
          url.searchParams.set('addressdetails', '1');
          const res = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
          const data = await res.json();
          if (Array.isArray(data) && data.length) {
            const hit = data[0];
            const lat = parseFloat(hit.lat), lon = parseFloat(hit.lon);
            const marker = L.marker([lat, lon], { icon: pastelMarker(color), title: m.name || hit.display_name });
            const label = m.name || hit.display_name;
            const addr = hit.display_name;
            marker.bindPopup(`<strong>${label}</strong><br/><div style="color:#6b7280">${addr}</div>${m.details ? `<hr style="border:none;border-top:1px solid #eee;margin:8px 0"/><div style="font-size:13px">${m.details}</div>` : ""}`);
            layers[layerKey].addLayer(marker);
            bounds.push([lat, lon]);
            await new Promise(r => setTimeout(r, 900)); // polite rate limit
          }
        }
        if (bounds.length) {
          const b = L.latLngBounds(bounds);
          map.fitBounds(b.pad(0.15));
        }
      } catch (e) {
        console.error('Dynamic add failed for', typeId, e);
      }
    }
    addDynamic('extra-markets', 'markets', '#bfe3ff');
    addDynamic('extra-recycling', 'recycling', '#ffd6e7');
    addDynamic('extra-collections', 'charities', '#fff1b6');

    // Layer control
    L.control.layers(null, {
      "Car boot / markets": layers.markets,
      "Recycling centres": layers.recycling,
      "Charities (collection)": layers.charities
    }, { collapsed: true }).addTo(map);

    const note = L.control({position:'bottomright'});
    note.onAdd = function() {
      const div = L.DomUtil.create('div'); div.className = 'source-note';
      div.innerHTML = "iPhone-ready layout • Base map: CARTO • Poppins font • Core places fixed (incl. Clothing banks) · Extras via OpenStreetMap/Nominatim";
      return div;
    };
    note.addTo(map);
  </script>
</body>
</html>
